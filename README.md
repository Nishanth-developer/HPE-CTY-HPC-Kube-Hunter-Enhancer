# Enhanced logging and metrics exporter for Kube-Hunter

Kube Hunter is a security tool developed by Aqua security team to detect threats in the cluster. It provides us with a wide range of scanning options and serves as one of the best security tool available in the market for kubernetes security. However the log file provided by the tool as a results is very simple and contains very little information.

A sample log file generated by Kube Hunter in a newly created kubernetes cluster in minikube:



## Screenshots

![p1](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/1976b39d-b49d-4589-bcb9-e0d62c0b927f)

This requires the user to get the ID from the log file (eg.KHV002) and search that ID in the official Kube Hunter website and get information about the threat.

eg. To know more information about the vulnerability ID khv002, then after searching the ID in the webpage https://aquasecurity.github.io/kube-hunter/ we get this below page rendered.

![p2](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/67cdd258-8711-4490-a579-b7742e784297)


Also it is clear that, there is no remediation on how to resolve a particular threat found in the cluster as they are only providing the reference links.

Hence my project focusses on generating a precise threat report which contains all the necessary information about the threats found in the cluster along with the remediation on how to resolve them, a clean dashboard to view those and also a metrics export option to view those metrics in dashboards like grafana.



## Installation

### Kube Hunter enhanced report setup

Head over to https://www.npoint.io/ and click 'create json bin'. Now at the bottom of the page you can find your unique json bin link. Copy the link to the clipboard.

Copy or git clone the script from the following link: https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer

Run the script by executing the command.

```bash
  bash script.sh
```
The script will prompt you to enter the NPoint JSON bin link. This is the link that you copied earlier when you created your JSON bin on https://www.npoint.io/

Enter your unique NPoint JSON bin link when prompted by the script.

Sample:

![p4](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/98fd0d3b-ae1c-4e88-8f16-a300cd84ecd6)


Now this will install the kube-Hunter on all the nodes in the cluster and provide you with a enhanced report of the threats found in the cluster along with the remediation. You can view the json generated by navigating to your npoint json bin link again. This time the empty json bin link will be populated with the enhanced log results of the cluster.


### Grafana setup

Now our goal is to visualise the results of the kube-hunter scans in grafana dashboard. For this execute the following steps sequentially.

#### Add Grafana Helm repo

```bash
  helm repo add grafana https://grafana.github.io/helm-charts
```

#### Install Grafana chart

```bash
  helm install grafana grafana/grafana
```

#### Expose Grafana service via NodePort in order to access Grafana UI

```bash
  kubectl expose service grafana --type=NodePort --target-port=3000 --name=grafana-np
```

#### Check exposed service

```bash
  kubectl get services
```

#### Get Grafana admin credentials

```bash
  kubectl get secret --namespace default grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
```

### Access Grafana Web UI

#### Expose Grafana service in minikube

```bash
  minikube service grafana-np --url
```

#### Access UI and enter admin credentials

![p3](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/1d0bde33-4780-4782-b7e9-df0c1642f640)

#### Plugin activation

On the lower left corner, click the Configurations wheel and navigate to Configuration > Plugins

![p5](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/78b2f944-5cfe-4808-a4f5-5ad931931ba7)

Now in the search bar, enter json and click 'JSON API'.

![p6](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/b3e689d9-47fa-43dc-9bb8-4fe2c4dc1990)

Click 'Create a JSON API Data Source'.

![p7](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/9089452d-b8e2-4300-825a-7c645f2958fd)

Now in the HTTP > URL field, enter your unique npoint.io json bin link.

![p8](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/3122af89-7b8b-40f8-9597-408ab7640656)

Click save and test. If you get a success message then the plugin is configured properly.

#### Importing dashboard

Go to the upper left section named dashboards, and navigate to the import dashboard section

![p9](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/285c4338-61f3-4e7e-bc5a-64343dcfa9d5)

Now a window will appear like this, prompting you to import a json file. Import the json file available in this repo named Kube-Hunter-Dashboard.json.

```bash
  https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/blob/main/Kube-Hunter-Dashboard.json
```
![p10](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/df6e2001-4a2b-4024-ab5d-fd4f3426fdbd)

After importing the json, select JSON API from datasources dropdown and click import.

![p11](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/1f176768-01fc-49dd-81fa-71ba124b2dea)

Now the Kube Hunter dashboard will be rendered with neccessary visualisations starting with the master table.

![p12](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/01813bdd-c5b1-4b4a-8246-ba176c120965)


## Optional

If you want a Kube Hunter security dashboard to view all threats found, information about them and their remediations, instead of the above grafana visualisation, then download the folder named Kube Hunter web in this repository. 

Then in the same working dir, execute

```bash
  python3 hunt.py
```

On successful execution it will prompt you to visit localhost:5000 to view the dashboard. Visit localhost:5000 and the Kube Hunter dashboard will be rendered.

![p13](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/e515c67f-6f9d-4c22-8910-6e5fec721ef1)

Click the view button to know more information about the particular threat

![p14](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/1baf796f-bf5e-40a7-9823-030409ab1dae)

To know about the remediation for the particular threat, click the solutions button

![p15](https://github.com/Nishanth-developer/HPE-CTY-HPC-Kube-Hunter-Enhancer/assets/72375481/e640f110-4612-4576-aeab-e5553aa2435b)

